name: Gitleaks Scan

on:
  workflow_call:
    inputs:
      soft-fail:
        description: 'Whether to continue on secret detection'
        required: false
        type: boolean
        default: false
      upload-sarif:
        description: 'Whether to upload SARIF results to Security tab'
        required: false
        type: boolean
        default: false

# Minimal permissions - escalate for SARIF upload
permissions:
  contents: read
  security-events: write

jobs:
  gitleaks-scan:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    env:
      GITLEAKS_VERSION: '8.29.0'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@92c522aaa6f53af082553dedc1596c80b71aba33 # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        if: hashFiles('package-lock.json') != ''
        uses: actions/setup-node@dda4788290998366da86b6a4f497909644397bb2 # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: hashFiles('package-lock.json') != ''
        run: npm ci

      - name: Install Gitleaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v${{ env.GITLEAKS_VERSION }}/gitleaks_${{ env.GITLEAKS_VERSION }}_linux_x64.tar.gz
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v${{ env.GITLEAKS_VERSION }}/gitleaks_${{ env.GITLEAKS_VERSION }}_checksums.txt
          sha256sum -c --ignore-missing gitleaks_${{ env.GITLEAKS_VERSION }}_checksums.txt
          tar -xzf gitleaks_${{ env.GITLEAKS_VERSION }}_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/
          chmod +x /usr/local/bin/gitleaks

      - name: Run Gitleaks scan
        id: gitleaks-scan
        run: |
          # Generate both JSON and SARIF outputs
          if ! gitleaks detect --source . --no-git --redact \
            --report-format json --report-path gitleaks-output.json \
            --log-opts="--all" > gitleaks-output.txt 2>&1; then
            echo "GITLEAKS_FAILED=true" >> $GITHUB_ENV
          fi
          
          # Generate SARIF output (always, even on failure)
          gitleaks detect --source . --no-git --redact \
            --report-format sarif --report-path gitleaks.sarif \
            --log-opts="--all" 2>&1 || true
          
          # Display console output
          cat gitleaks-output.txt
        continue-on-error: true

      - name: Create annotations
        if: env.GITLEAKS_FAILED == 'true'
        run: |
          echo "::error::Gitleaks detected potential secrets. Review gitleaks-results artifact for details."

      - name: Upload SARIF to Security tab
        if: inputs.upload-sarif && always()
        uses: github/codeql-action/upload-sarif@95b1867cf797beb28ce725a6f25268e2d3304672 # v3.27.0
        with:
          sarif_file: gitleaks.sarif
          category: gitleaks
        continue-on-error: true

      - name: Upload Gitleaks results as artifact
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v4.4.3
        with:
          name: gitleaks-results
          path: |
            gitleaks-output.json
            gitleaks-output.txt
            gitleaks.sarif
          retention-days: 30

      - name: Add job summary
        if: always()
        run: |
          echo "## Gitleaks Secret Scan Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.GITLEAKS_FAILED }}" == "true" ]; then
            echo "❌ **Status**: Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **SECURITY ALERT**: Potential secrets detected in repository." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the gitleaks-results artifact" >> $GITHUB_STEP_SUMMARY
            echo "2. Rotate any exposed secrets immediately" >> $GITHUB_STEP_SUMMARY
            echo "3. Remove secrets from git history if needed" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **Status**: Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No secrets detected in repository." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail job if secrets found
        if: env.GITLEAKS_FAILED == 'true' && !inputs.soft-fail
        run: |
          echo "Gitleaks scan failed - secrets detected"
          exit 1
