name: Release Validation

on:
  pull_request:
    branches:
      - main

# Minimal permissions for security
permissions:
  contents: read
  security-events: write

jobs:
  # Detect if this is a release PR
  detect-release-pr:
    name: Detect Release PR
    runs-on: ubuntu-latest
    outputs:
      is-release: ${{ steps.check.outputs.is-release }}
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Check if release PR
        id: check
        run: |
          if [[ "${{ github.event.pull_request.user.login }}" == "github-actions[bot]" ]] && \
             [[ "${{ github.event.pull_request.title }}" =~ ^chore\(main\):\ release ]]; then
            echo "is-release=true" >> $GITHUB_OUTPUT
          else
            echo "is-release=false" >> $GITHUB_OUTPUT
          fi

  # Run all validation checks before allowing release
  spell-check:
    name: Spell Check
    needs: detect-release-pr
    if: needs.detect-release-pr.outputs.is-release == 'true'
    uses: ./.github/workflows/spell-check.yml
    permissions:
      contents: read
    with:
      soft-fail: false

  markdown-lint:
    name: Markdown Lint
    needs: detect-release-pr
    if: needs.detect-release-pr.outputs.is-release == 'true'
    uses: ./.github/workflows/markdown-lint.yml
    permissions:
      contents: read
    with:
      soft-fail: false

  table-format:
    name: Table Format Check
    needs: detect-release-pr
    if: needs.detect-release-pr.outputs.is-release == 'true'
    uses: ./.github/workflows/table-format.yml
    permissions:
      contents: read
    with:
      soft-fail: false

  psscriptanalyzer:
    name: PowerShell Lint
    needs: detect-release-pr
    if: needs.detect-release-pr.outputs.is-release == 'true'
    uses: ./.github/workflows/ps-script-analyzer.yml
    permissions:
      contents: read
    with:
      changed-files-only: false

  frontmatter-validation:
    name: Frontmatter Validation
    needs: detect-release-pr
    if: needs.detect-release-pr.outputs.is-release == 'true'
    uses: ./.github/workflows/frontmatter-validation.yml
    permissions:
      contents: read
    with:
      soft-fail: false
      changed-files-only: false
      skip-footer-validation: false
      warnings-as-errors: true

  link-lang-check:
    name: Link Language Check
    needs: detect-release-pr
    if: needs.detect-release-pr.outputs.is-release == 'true'
    uses: ./.github/workflows/link-lang-check.yml
    permissions:
      contents: read
    with:
      soft-fail: false

  markdown-link-check:
    name: Markdown Link Check
    needs: detect-release-pr
    if: needs.detect-release-pr.outputs.is-release == 'true'
    uses: ./.github/workflows/markdown-link-check.yml
    permissions:
      contents: read
    with:
      soft-fail: false

  dependency-pinning-check:
    name: Validate Dependency Pinning
    needs: detect-release-pr
    if: needs.detect-release-pr.outputs.is-release == 'true'
    uses: ./.github/workflows/dependency-pinning-scan.yml
    permissions:
      contents: read
      security-events: write
    with:
      soft-fail: false
      upload-sarif: true
      upload-artifact: false

  sha-staleness-check:
    name: SHA Staleness Check
    needs: detect-release-pr
    if: needs.detect-release-pr.outputs.is-release == 'true'
    uses: ./.github/workflows/sha-staleness-check.yml
    permissions:
      contents: read
    with:
      max-age-days: 90

  validation-summary:
    name: Release Validation Summary
    needs:
      - detect-release-pr
      - spell-check
      - markdown-lint
      - table-format
      - psscriptanalyzer
      - frontmatter-validation
      - link-lang-check
      - markdown-link-check
      - dependency-pinning-check
      - sha-staleness-check
    if: needs.detect-release-pr.outputs.is-release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Release validation summary
        run: |
          echo "âœ… All validation checks passed"
          echo "ðŸŽ‰ Release PR is ready to merge"
