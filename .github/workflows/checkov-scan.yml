name: Checkov Scan

on:
  workflow_call:
    inputs:
      soft-fail:
        description: 'Whether to continue on security violations'
        required: false
        type: boolean
        default: false
      upload-sarif:
        description: 'Whether to upload SARIF results to Security tab'
        required: false
        type: boolean
        default: false

# Escalated permissions for SARIF upload
permissions:
  contents: read
  security-events: write

jobs:
  checkov-scan:
    name: Checkov IaC Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@92c522aaa6f53af082553dedc1596c80b71aba33 # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v4.2.2
        with:
          persist-credentials: false

      - name: Setup Python for Checkov
        uses: actions/setup-python@cfd55ca82492758d853442341ad4d8010466803a # v5.3.0
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: pip install -r requirements.txt

      - name: Run Checkov scan
        id: checkov-scan
        run: |
          checkov -d . \
            --framework github_actions json yaml secrets \
            --output sarif \
            --output-file-path console,checkov-results.sarif \
            --evaluate-variables > checkov-output.txt 2>&1 || echo "CHECKOV_FAILED=true" >> $GITHUB_ENV
          cat checkov-output.txt
        continue-on-error: true

      - name: Create annotations
        if: env.CHECKOV_FAILED == 'true'
        run: |
          echo "::warning::Checkov detected security violations. Review checkov-results artifact for details."

      - name: Upload SARIF to Security tab
        if: inputs.upload-sarif && always()
        uses: github/codeql-action/upload-sarif@95b1867cf797beb28ce725a6f25268e2d3304672 # v3.27.0
        with:
          sarif_file: checkov-results.sarif
          category: checkov

      - name: Upload Checkov results as artifact
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v4.4.3
        with:
          name: checkov-results
          path: |
            checkov-results.sarif
            checkov-output.txt
          retention-days: 30

      - name: Add job summary
        if: always()
        run: |
          echo "## Checkov IaC Security Scan Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.CHECKOV_FAILED }}" == "true" ]; then
            echo "âŒ **Status**: Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Security violations detected in Infrastructure as Code." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Frameworks scanned:**" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub Actions workflows" >> $GITHUB_STEP_SUMMARY
            echo "- JSON configurations" >> $GITHUB_STEP_SUMMARY
            echo "- YAML configurations" >> $GITHUB_STEP_SUMMARY
            echo "- Secrets detection" >> $GITHUB_STEP_SUMMARY
            if [ "${{ inputs.upload-sarif }}" == "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ“Š **View detailed results in the Security tab**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… **Status**: Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No security violations detected." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail job if violations found
        if: env.CHECKOV_FAILED == 'true' && !inputs.soft-fail
        run: |
          echo "Checkov scan failed - security violations detected"
          exit 1
