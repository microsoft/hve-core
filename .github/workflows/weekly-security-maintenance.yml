name: Weekly Security Maintenance

on:
  schedule:
    - cron: '0 2 * * 0' # Sundays at 2 AM UTC
  workflow_dispatch:
    inputs:
      staleness-threshold:
        description: 'SHA staleness threshold in days'
        required: false
        type: number
        default: 30

permissions:
  contents: read
  security-events: write

jobs:
  # Job 1: Validate all dependencies are SHA-pinned
  validate-pinning:
    name: Validate SHA Pinning Compliance
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      compliance-score: ${{ steps.pinning.outputs.compliance-score }}
      unpinned-count: ${{ steps.pinning.outputs.unpinned-count }}
      has-violations: ${{ steps.pinning.outputs.has-violations }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@92c522aaa6f53af082553dedc1596c80b71aba33 # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v4.2.2
        with:
          persist-credentials: false

      - name: Run SHA Pinning Validation
        id: pinning
        shell: pwsh
        run: |
          Write-Host "Validating dependency SHA pinning compliance..."
          & scripts/security/Test-DependencyPinning.ps1 `
            -Path . `
            -Format json `
            -OutputPath logs/dependency-pinning-results.json
          
          # Extract metrics from report
          $report = Get-Content logs/dependency-pinning-results.json | ConvertFrom-Json
          $complianceScore = $report.ComplianceScore
          $unpinnedCount = $report.UnpinnedDependencies
          
          "compliance-score=$complianceScore" >> $env:GITHUB_OUTPUT
          "unpinned-count=$unpinnedCount" >> $env:GITHUB_OUTPUT
          "has-violations=$(if ($unpinnedCount -gt 0) { 'true' } else { 'false' })" >> $env:GITHUB_OUTPUT
          
          Write-Host "Compliance Score: $complianceScore%"
          Write-Host "Unpinned Dependencies: $unpinnedCount"
          
          # Fire GitHub Actions warnings for each violation
          if ($unpinnedCount -gt 0) {
            foreach ($violation in $report.Violations) {
              Write-Output "::warning file=$($violation.File),line=$($violation.Line)::Unpinned $($violation.Type) dependency: $($violation.Name)@$($violation.Version) (Severity: $($violation.Severity))"
            }
          }

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v4.4.3
        with:
          name: dependency-pinning-results
          path: logs/dependency-pinning-results.json
          retention-days: 90

  # Job 2: Check for stale SHA pins
  check-staleness:
    name: Check SHA Staleness
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      stale-count: ${{ steps.staleness.outputs.stale-count }}
      has-stale: ${{ steps.staleness.outputs.has-stale }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@92c522aaa6f53af082553dedc1596c80b71aba33 # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v4.2.2
        with:
          persist-credentials: false

      - name: Run SHA Staleness Check
        id: staleness
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $thresholdDays = if ('${{ github.event.inputs.staleness-threshold }}') { 
            [int]'${{ github.event.inputs.staleness-threshold }}' 
          } else { 
            30 
          }
          
          Write-Host "Checking SHA staleness with $thresholdDays day threshold..."
          
          # Run staleness check and capture output
          & scripts/security/Test-SHAStaleness.ps1 `
            -MaxAge $thresholdDays `
            -OutputFormat github `
            -OutputPath logs/sha-staleness-results.json
          
          # Extract stale count from JSON report
          if (Test-Path sha-staleness-report.json) {
            $report = Get-Content sha-staleness-report.json | ConvertFrom-Json
            $staleCount = ($report.StaleDependencies | Where-Object { $_.Age -gt $thresholdDays } | Measure-Object).Count
            "stale-count=$staleCount" >> $env:GITHUB_OUTPUT
            "has-stale=$(if ($staleCount -gt 0) { 'true' } else { 'false' })" >> $env:GITHUB_OUTPUT
            
            Write-Host "Stale Dependencies Found: $staleCount"
            
            # Fire warnings for each stale dependency
            foreach ($staleDep in $report.StaleDependencies) {
              if ($staleDep.Age -gt $thresholdDays) {
                Write-Output "::warning file=$($staleDep.File),line=$($staleDep.Line)::Stale SHA detected: $($staleDep.Action)@$($staleDep.CurrentSHA) is $($staleDep.Age) days old (latest: $($staleDep.LatestSHA))"
              }
            }
          } else {
            "stale-count=0" >> $env:GITHUB_OUTPUT
            "has-stale=false" >> $env:GITHUB_OUTPUT
          }

      - name: Upload staleness report
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v4.4.3
        with:
          name: sha-staleness-results
          path: logs/sha-staleness-results.json
          retention-days: 90

  # Job 3: Run security scans (Gitleaks)
  gitleaks-scan:
    name: Gitleaks Secret Scan
    uses: ./.github/workflows/gitleaks-scan.yml
    permissions:
      contents: read
      security-events: write
    with:
      soft-fail: true
      upload-sarif: true

  # Job 4: Run security scans (Checkov)
  checkov-scan:
    name: Checkov IaC Scan
    uses: ./.github/workflows/checkov-scan.yml
    permissions:
      contents: read
      security-events: write
    with:
      soft-fail: true
      upload-sarif: true

  # Job 5: Generate consolidated summary
  summary:
    name: Security Maintenance Summary
    needs: [validate-pinning, check-staleness, gitleaks-scan, checkov-scan]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Generate summary
        shell: pwsh
        run: |
          $pinningScore = '${{ needs.validate-pinning.outputs.compliance-score }}'
          $unpinnedCount = '${{ needs.validate-pinning.outputs.unpinned-count }}'
          $staleCount = '${{ needs.check-staleness.outputs.stale-count }}'
          $gitleaksResult = '${{ needs.gitleaks-scan.result }}'
          $checkovResult = '${{ needs.checkov-scan.result }}'
          
          # Determine overall status
          $hasIssues = $false
          if ($unpinnedCount -ne '0') { $hasIssues = $true }
          if ($staleCount -ne '0') { $hasIssues = $true }
          
          @"
          # ðŸ” Weekly Security Maintenance Report
          
          **Execution Time:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
          **Trigger:** ${{ github.event_name }}
          
          ## ðŸ“Š Dependency Health
          
          | Metric | Status | Details |
          |--------|--------|---------|
          | SHA Pinning Compliance | $(if ($unpinnedCount -eq '0') { 'âœ… Pass' } else { 'âš ï¸ Warning' }) | Score: $pinningScore% |
          | Unpinned Dependencies | $(if ($unpinnedCount -eq '0') { 'âœ… None' } else { "âš ï¸ $unpinnedCount found" }) | $(if ($unpinnedCount -ne '0') { 'Review warnings above' } else { 'All pinned' }) |
          | Stale SHAs (>30 days) | $(if ($staleCount -eq '0') { 'âœ… None' } else { "âš ï¸ $staleCount found" }) | $(if ($staleCount -ne '0') { 'Review warnings above' } else { 'All current' }) |
          
          ## ðŸ›¡ï¸ Security Scans
          
          | Scanner | Result |
          |---------|--------|
          | Gitleaks (Secrets) | $(if ($gitleaksResult -eq 'success') { 'âœ… Pass' } else { 'âš ï¸ See details' }) |
          | Checkov (IaC) | $(if ($checkovResult -eq 'success') { 'âœ… Pass' } else { 'âš ï¸ See details' }) |
          
          $(if ($unpinnedCount -ne '0') {
            @"
          
          ## âš ï¸ Action Required: Unpinned Dependencies
          
          **$unpinnedCount dependencies are not SHA-pinned.** This is a security risk.
          
          **To fix:**
          ``````powershell
          # Review the warnings above, then pin each dependency to a SHA
          # Example: Change 'uses: actions/checkout@v4' to 'uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v4.2.2'
          ``````
          
          "@
          })
          
          $(if ($staleCount -ne '0') {
            @"
          
          ## â„¹ï¸ Recommended: Update Stale SHAs
          
          **$staleCount SHA pins are outdated (>30 days old).** Consider updating them.
          
          **To update:**
          ``````powershell
          # Run the update script to get latest SHAs
          scripts/security/Update-ActionSHAPinning.ps1 -Path .github/workflows -UpdateStale
          ``````
          
          "@
          })
          
          $(if (!$hasIssues) {
            @"
          
          ## âœ… All Clear!
          
          Repository security posture is excellent:
          - All dependencies are SHA-pinned
          - All SHAs are current (< 30 days old)
          - No security scan issues
          
          "@
          })
          
          ---
          
          ðŸ“¥ **Detailed Reports:** Download artifacts from this workflow run  
          ðŸ”— **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          $(if ($hasIssues) {
            @"
          
          ### ðŸ“‹ Next Steps
          
          1. Review the build warnings generated in this workflow run
          2. For unpinned dependencies: Pin them to SHAs immediately (security risk)
          3. For stale SHAs: Update them when convenient (maintenance task)
          4. Download the JSON report artifacts for detailed analysis
          
          "@
          })
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8

      - name: Set workflow conclusion
        shell: pwsh
        run: |
          $unpinnedCount = '${{ needs.validate-pinning.outputs.unpinned-count }}'
          $staleCount = '${{ needs.check-staleness.outputs.stale-count }}'
          
          # Informational output - workflow succeeds but logs warnings
          if ($unpinnedCount -ne '0') {
            Write-Output "::warning::Found $unpinnedCount unpinned dependencies. Review build warnings for details."
          }
          
          if ($staleCount -ne '0') {
            Write-Output "::warning::Found $staleCount stale SHA pins (>30 days old). Consider updating them."
          }
          
          if ($unpinnedCount -eq '0' -and $staleCount -eq '0') {
            Write-Output "::notice::All dependencies are properly pinned and up-to-date!"
          }
